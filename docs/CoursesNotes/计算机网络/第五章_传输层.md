# 第五章：传输层

## 目录
[[toc]]

## 5.1 传输层提供的服务

### 传输层的功能

网络层提供了主机的逻辑通信，但是不提供可靠传输，这部分由传输层完成。传输层可以提供进程之间的可靠传输。

传输层只存在于通信子网以外的主机，事实上通信子网的主机只负责主机之间的传输，所以不存在传输层。

传输层的功能如下：

1. 传输层提供应用进程之间的逻辑通信，即端对端通信。逻辑通信指的是两者看似沿水平方向传输，但事实上不存在一条实际的信道连接两者。
2. 复用与分用。复用指发送方不同的应用程序可以使用同一协议发送数据包，分用指除去首部后你呢个够把数据正确交付到目的进程。网络层也有此功能，但是其复用表示不同的上层协议都可以封装成 IP 报文发送出去，分用指接收方剥去首部后把数据交付给对应协议。
3. 传输层还要提供差错检测，包括首部和数据，网络层只检测首部信息。
4. 提供两种服务，面向连接的 TCP 和无连接的 UDP。网络层不能同时实现两种协议，要么是面向连接的虚电路，要么是提供无连接服务，如数据报。

传输层屏蔽了下层协议的实现和细节，向上提供了一条逻辑信道，对于 TCP 这是一条可靠信道，对于 UDP 则是一条不可靠信道。

### 传输层的寻址与端口

#### 端口的作用

端口在传输层的作用类似于网络层中的 IP 和数据链路层中的 MAC，起到唯一标识的作用。端口是服务访问点 SAP，是应用程序定位的依据。传输层的端口是一种软件端口，事实上是虚拟的，这与硬件层面的端口有区别。

#### 端口号

应用程序使用端口标识，端口号长度是 16 位，也就是能标识 65536 个端口。端口号只标识本地主机的进程，因此互联网上相同的端口号之间没有联系，端口号可分为两类，服务器端使用的和客户端使用的端口号。

- 服务端使用的端口号：0～49151
  - 熟知端口号：由 IANA 分配的，给最重要的 TCP/IP 应用程序，让所有用户知道。0～1023
  - 登记端口号：使用需要向 IANA 登记，给没有熟知端口号的应用程序使用。1024～49151
- 客户端使用的端口号：49152～65536，应用程序运行时动态选择，临时端口号，连接关闭后回收供应用再次使用。

#### 套接字

套接字 Socket 时通信端点，利用 IP 和端口号唯一定位网络上一个主机上的一个进程。Socket 就是由 IP 地址拼接上端口组成，发送报文时通过 Socket 定位。

### 无连接和面向连接服务

无连接服务指的是传输前不建立连接，消息需要发送直接放入网络传输，尽力传输。面向连接服务在通信前先建立连接然后再通信，通信过程监控整个连接状态，通信结束释放连接。TCP/IP 协议实现了 TCP 和 UDP 两种服务，对应面向连接和无连接服务。

TCP 提供面向连接服务，不提供组播和广播，提供全双工的可靠传输，因此增加了开销，诸如接受确认，流量控制，计时器，拥塞控制，连接管理。这使得头部大小增大，而且需要消耗更多处理机资源，适用于对可靠性要求高的服务，例如文件传输 FTP，超文本传输服务 HTTP，远程登录 TELNET 等。

UDP 提供无连接服务，是传输层对 IP 的进一步封装，增加了多路复用和差错检测。因为 UDP 简单，执行速度快，实时性好，使用的应用有小文件传输协议 TFTP，DNS，SNMP 和实时传输协议 RTP。

::: tip IP报文和UDP报文的区别

IP 数据需要路由器转发，而 UDP 的报文对网络层是不可见的。其次 UDP 中包含端口号，用于定位进程，而 IP 报文首部只有 IP 地址，定位主机。

:::

::: tip TCP和网络层虚电路的区别

TCP 报文段在传输层抽象的逻辑信道传输，对路由器不可见，虚电路在网络层，因此经过交换节点需要记录虚电路的状态信息。另外，网络层使用虚电路后无法提供无连接服务，而 TCP 使用并不影响网络层提供无连接服务。

:::

### 题目精选

#### 顺序交付

::: danger 关于传输层的面向连接服务的特性是

- [ ] 不保证可靠和顺序交付
- [ ] 不保证可靠但保证顺序交付
- [x] 保证可靠但不保证顺序交付
- [ ] 保证可靠和顺序交付

:::

::: tip 顺序交付的理解

- [x] 保证可靠和顺序交付

保证顺序交付的意思应该是最后可以还原成正确顺序的包，此处错误理解成保证包顺序到达。到达的 TCP 包可能顺序打乱但最后交付是可以复原的，因此理解为保证顺序交付。

:::

#### IP 首部与 TCP 首部的长度

::: warning IP首部与TCP首部的长度

两者首部大小均为 20B，这种情况指的是 TCP 和 IP 报文的首部都不包含附加字段。

:::

## 5.2 UDP 协议

### UDP 数据报

#### UDP 概述

当应用决定使用 UDP 后，几乎与 IP 打交道，需要自己保证完整性。虽然 TCP 提供了很多的功能和可靠的服务，但是造成的开销也是很大的。因此 UDP 提供的快速成为很多即时应用的选择。UDP 有以下的优点：

1. UDP 无需建立连接，不存在建立连接的时延。
2. 无连接状态，无需维护连接。相比维护连接的 TCP，服务器能支持更多活动机。
3. 分组首部开销小，TCP 有 20B 的首部开销，UDP 只有 8B。
4. 应用层能更好地控制发送时间，TCP 可能由于拥塞控制和流量控制导致发送延时。
5. UDP 支持一对一，一对多，多对一，多对多的交互通信。

UDP 的优势在于低时延，诸如 DNS 等服务，建立连接的时延是无法接受的。视频会议，实时通信和流媒体，直播等服务倾向使用 UDP，因为保证实时性和低延迟可以容忍部份数据丢失，或者说丢失的数据对于实时应用没有意义了。

UDP 不保证可靠交付，但不代表应用不需要可靠传输，而是 UDP 之上的应用层会自行保证可靠交付，一般来说这种可靠交付会比 TCP 更加宽松，但是更多保证低时延。

UDP 的报文是不分割的，添加首部后就会下传给 IP 层，因此应用层必须谨慎选择报文大小，报文太长会导致 IP 层分片，太小导致首部相对大小太大，两者都会降低 IP 层效率。

::: tip IP 层的分片如何保证有序性

IP 层的分片与 TCP 的分段事实上是一个意思，就是超出协议栈支持的最大大小单元的时候需要做出切分的操作。由于 TCP 有分段的概念，于是 IP 层一般不需要分片，但也存在不同第三层设备的最大支持大小不同导致中间的分片。主要分片还是在于 UDP 的报文，由于 UDP 的设计是为了快速，因此报文没有分段操作，太大就需要 IP 分层。

此处由于我没有按顺序复习，因此 IP 分层的知识可能没有印象。IP 保证分片的有序性是由 16 位标识位和 3 位标志位和 13 位偏移量组成的。标识位标识每一个包，识别一个包的不同段，偏移量用于复位包。标识位 R 保留；DF (Don't Fragment) 标识的是不分段，此时如果需要分段该报文就会被丢弃；MF (More Fragment) 标识的是有更多的包，除了没有分段和分段的最后一段标记为 0，其他均为 1，表示还有还有分段。

需要注意 IP 没有重传机制，因此有报文丢失那么这整个段就会丢失，TCP 不存在分段，UDP 就需要应用层自己控制，因为 UDP 对丢包的处理就是不处理。此处还涉及 ICMP 的相关处理，如果要求不分段那么会返回 ICMP 差错报文。

参考资料：

[IP 分片浅析](https://www.cnblogs.com/diegodu/p/4647644.html) - [我是东东东](https://cloud.tencent.com/developer/user/1270711)

[TCP 分段与 IP 分片的区别与联系](https://cloud.tencent.com/developer/article/1173790) - [穆穆兔兔](https://home.cnblogs.com/u/diegodu/)

:::

#### UDP的首部格式

UDP的首部大小为8B，分为四个字段，每个部分都是2B，每个部分如下：

- 源端口号：在需要回信的时候填写，不需要全为0
- 目的端口：交付时使用
- 长度：数据报文的长度，包括首部和数据段
- 校验和：用于差错检测，此子段可选，不需要时全置为0

接收方如果发现对应的端口号未开放，就会丢弃包并且通过ICMP发送端口不可达的差错报文给发送方。

### UDP 校验

UDP的校验和计算