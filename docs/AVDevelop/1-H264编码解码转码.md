# 第一节 H264 编码解码转码

## 1 音视频基础

这里我打算写一下新的概念以及一些刚入门的疑惑。

### 1.1 图片编码

#### YUV 与 RGB

我接触较多的是 RGB，这种对像素的描述我们很好理解，就是通过三个分量 R、G 和 B 获得各种颜色。但是 YUV 这种格式采用了一种完全不同的想法，也许我们可以用轮廓和颜色来表示，也就是把色彩和轮廓分离了，先给出一张黑白图片，再通过 UV 分量进行渲染。

后面会提到，YUV 更适合人眼，因为人眼对一些信息的敏感度更高，对于 Y 分量描述的轮廓更敏感，因此我们可以适当压缩 UV 分量，实现有损压缩。当然也可以选择不压缩，这取决于我们。

### 1.2 视频编码

#### 视频压缩

通过上面的编码我们就可以表示一张图片了，而视频压缩的本质就是信息存在冗余，主要就是以下几方面：

- 空间冗余：同一帧图片，相邻的块有相似的信息
- 时间冗余：相邻的帧差别可能很小，有大量的重复信息
- 视觉冗余：针对人而言，对部分细节不敏感，对低频信息可以压缩
- 信息冗余：不同的信息出现的频率不同，参考哈夫曼编码，可以让高频出现的使用比较小的数字表示，使用位数就少

但是宇宙总是存在某一种平衡，以上种种，要么损失了信息，要么就是用时间换空间。

#### 图像帧的类型

- I 帧：关键帧，这种帧只存在帧内预测，不会参考前后帧
- B 帧：双向帧，会参考前后的帧
- P 帧：P 帧会参考前面的帧

B 帧会带来编码延迟，因为如果参考后面的帧，那么需要先编码后面的帧，这里如果连续出现 B 帧，那么是否有可能出现大延迟。使用 B 帧会导致编码顺序和显示顺序混乱，因此一般在直播等场景很少使用。

#### Group of Picture（GoP）

GoP 指的是两个 I 帧之间的一组图片，一般会设置一个间隔，多久需要一个 I 帧。根据不同的场景有不同的设置，例如直播应该适当减少一点，因为除了 I 帧以外，其他帧都需要参考前面的帧，因此第一个画面出现必须是 I 帧到达后。设想如果你进入直播间，刚好错过发送的 I 帧，那么你需要等待 5 秒甚至 10 秒，这是无法接受的。一般直播设置为一秒帧数的倍数，25 或者 50.非直播会适当增加 GoP 和 B 帧的数量，这样可以增加压缩率和降低码率。

GoP 越大视频压缩率就会越大，同时视频流也就越难恢复。

## 2 H264 编码

### 2.1 宏块扫描



